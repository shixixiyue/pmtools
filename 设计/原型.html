<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“ç”»å¸ƒ / SWOTåˆ†æ</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      
      /* ç‹‚é‡çº¿æ¡æ•ˆæœ */
      .wild-border {
        border: 3px solid;
        box-shadow: 4px 4px 0px rgba(0,0,0,0.3);
      }
      
      /* åˆ‡æ¢æŒ‰é’®æ¿€æ´»çŠ¶æ€ */
      .mode-btn-active {
        transform: translateY(-2px);
        box-shadow: 0 4px 0 rgba(0,0,0,0.3);
      }
      
      .mode-btn-inactive {
        opacity: 0.6;
      }
      
      /* å¯¹è¯æ°”æ³¡æ ·å¼ */
      .chat-bubble-user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 14px;
        max-width: 80%;
        border: 2px solid #000;
        box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
      }
      
      .chat-bubble-ai {
        background: #fff;
        color: #1f2937;
        padding: 10px 14px;
        max-width: 85%;
        border: 2px solid #10b981;
        box-shadow: 2px 2px 0 rgba(16, 185, 129, 0.3);
      }
      
      /* SVGå ä½ç¬¦æ ·å¼ - å—çº§æ¢è¡Œ + æ–°é…è‰² */
      .svg-placeholder-block {
        display: block;
        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        color: white;
        padding: 8px 14px;
        margin: 8px 0;
        border: 2px solid #000;
        box-shadow: 3px 3px 0 rgba(0,0,0,0.25);
        font-weight: bold;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }
      
      .svg-placeholder-block:hover {
        transform: translateX(2px) translateY(-2px);
        box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #fb923c 0%, #f87171 100%);
      }
      
      /* æ°”æ³¡æ“ä½œæŒ‰é’® */
      .bubble-action-btn {
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .chat-bubble-ai:hover .bubble-action-btn {
        opacity: 1;
      }
      
      /* å°æ‰‹æ‘‡æ‘†åŠ¨ç”» */
      @keyframes wave {
        0%, 100% {transform: translateX(0px) rotate(90deg);}
        10%, 30%, 50%, 70%, 90% {transform: translateX(-1px) rotate(90deg);}
        20%, 40%, 60%, 80% {transform: translateX(1px) rotate(90deg);}
      }
      
      .wave-hand {
        animation: wave 3s ease-in-out infinite;
        display: inline-block;
        transform: rotate(90deg);
      }
      
      /* æ¨¡æ€çª—æ ·å¼ */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      .modal-overlay.active {
        display: flex;
      }
      
      .modal-content {
        background: white;
        border: 4px solid #000;
        box-shadow: 8px 8px 0 rgba(0,0,0,0.4);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      /* è¡¨å•è¾“å…¥æ¡†æ ·å¼ */
      .config-input {
        width: 100%;
        padding: 10px;
        border: 2px solid #000;
        font-size: 14px;
        transition: all 0.2s;
      }
      
      .config-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 3px 3px 0 rgba(102, 126, 234, 0.3);
      }
      
      /* é½¿è½®æ—‹è½¬åŠ¨ç”» */
      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      .settings-btn:hover iconify-icon {
        animation: rotate 1s linear infinite;
      }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <header class="bg-gradient-to-r from-orange-500 to-pink-500 p-3 flex items-center justify-between border-b-4 border-black">
      <div class="flex items-center space-x-2">
        <iconify-icon icon="ph:lightning-fill" class="text-3xl text-white"></iconify-icon>
        <h1 id="page-title" class="text-2xl font-black text-white tracking-tight">äº§å“ç”»å¸ƒ</h1>
      </div>
      
      <!-- å³ä¾§æŒ‰é’®ç»„ -->
      <div class="flex items-center gap-3">
        <!-- APIé…ç½®æŒ‰é’® -->
        <button id="settings-btn" class="settings-btn bg-white/20 text-white p-2 border-2 border-white hover:bg-white/30 transition-all" title="APIé…ç½®">
          <iconify-icon icon="ph:gear-six-fill" class="text-2xl"></iconify-icon>
        </button>
        
        <span class="text-white font-bold text-sm">ç‚¹å‡»åˆ‡æ¢æ¨¡å¼</span>
        <iconify-icon icon="ph:hand-pointing-fill" class="text-2xl text-yellow-300 wave-hand"></iconify-icon>
        
        <button id="canvas-mode-btn" class="mode-btn-active bg-white text-orange-600 px-4 py-2 font-bold border-2 border-black hover:bg-orange-50 transition-all duration-200">
          <iconify-icon icon="ph:pen-nib-duotone" class="align-middle mr-1"></iconify-icon>
          äº§å“ç”»å¸ƒ
        </button>
        <button id="swot-mode-btn" class="mode-btn-inactive bg-white text-purple-600 px-4 py-2 font-bold border-2 border-black hover:bg-purple-50 transition-all duration-200">
          <iconify-icon icon="ph:chart-bar-duotone" class="align-middle mr-1"></iconify-icon>
          SWOTåˆ†æ
        </button>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4 p-4 overflow-hidden">
    
      <!-- å·¦ä¾§å¯¹è¯é¢æ¿ -->
      <div class="md:col-span-1 bg-white wild-border border-cyan-500 flex flex-col">
        <!-- å¯¹è¯å†å²åŒº -->
        <div id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-3">
          
          <!-- ç”¨æˆ·æ¶ˆæ¯ -->
          <div class="flex justify-end">
            <div class="chat-bubble-user">
              å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªç”µå•†äº§å“çš„ç”»å¸ƒ
            </div>
          </div>
          
          <!-- AIå›å¤ - åŒ…å«SVGå ä½ç¬¦ï¼ˆæ¢è¡Œï¼‰ -->
          <div class="flex justify-start">
            <div class="chat-bubble-ai relative group" data-message-id="msg-1">
              <div>
                å¥½çš„ï¼æˆ‘ä¸ºæ‚¨ç”Ÿæˆäº†ä¸€ä¸ªç”µå•†äº§å“ç”»å¸ƒï¼Œ
                <div class="svg-placeholder-block" data-svg-id="svg-1" onclick="viewSVG('svg-1')">
                  ğŸ“Š ç‚¹å‡»æŸ¥çœ‹äº§å“ç”»å¸ƒ SVG
                </div>
                åŒ…å«äº†ç›®æ ‡ç”¨æˆ·ã€æ ¸å¿ƒä»·å€¼ã€å…³é”®åŠŸèƒ½ç­‰æ¨¡å—ã€‚ç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾å¯åœ¨å³ä¾§æŸ¥çœ‹è¯¦ç»†å›¾è¡¨ã€‚
              </div>
              
              <!-- æ‚¬æµ®æ“ä½œæŒ‰é’® -->
              <div class="flex gap-2 mt-2 pt-2 border-t border-gray-200">
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-blue-600 transition-colors" onclick="rollbackToMessage('msg-1')">
                  <iconify-icon icon="ph:arrow-u-up-left-bold"></iconify-icon>
                  <span>é€€å›</span>
                </button>
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-green-600 transition-colors" onclick="regenerateMessage('msg-1')">
                  <iconify-icon icon="ph:arrow-clockwise-bold"></iconify-icon>
                  <span>é‡æ–°ç”Ÿæˆ</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- ç”¨æˆ·æ¶ˆæ¯ -->
          <div class="flex justify-end">
            <div class="chat-bubble-user">
              èƒ½ä¸èƒ½è°ƒæ•´ä¸€ä¸‹é…è‰²æ–¹æ¡ˆï¼Ÿ
            </div>
          </div>
          
          <!-- AIå›å¤ - åŒ…å«SVGå ä½ç¬¦ï¼ˆæ¢è¡Œï¼‰ -->
          <div class="flex justify-start">
            <div class="chat-bubble-ai relative group" data-message-id="msg-2">
              <div>
                å½“ç„¶å¯ä»¥ï¼æˆ‘å·²ç»ä¸ºæ‚¨è°ƒæ•´äº†é…è‰²ï¼Œ
                <div class="svg-placeholder-block" data-svg-id="svg-2" onclick="viewSVG('svg-2')">
                  ğŸ“Š ç‚¹å‡»æŸ¥çœ‹ä¼˜åŒ–åçš„ SVG
                </div>
                é‡‡ç”¨äº†æ›´åŠ ç°ä»£å’Œé²œæ˜çš„è‰²å½©ç»„åˆï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„è§†è§‰å±‚æ¬¡ã€‚
              </div>
              
              <!-- æ‚¬æµ®æ“ä½œæŒ‰é’® -->
              <div class="flex gap-2 mt-2 pt-2 border-t border-gray-200">
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-blue-600 transition-colors" onclick="rollbackToMessage('msg-2')">
                  <iconify-icon icon="ph:arrow-u-up-left-bold"></iconify-icon>
                  <span>é€€å›</span>
                </button>
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-green-600 transition-colors" onclick="regenerateMessage('msg-2')">
                  <iconify-icon icon="ph:arrow-clockwise-bold"></iconify-icon>
                  <span>é‡æ–°ç”Ÿæˆ</span>
                </button>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- è¾“å…¥åŒº -->
        <div class="p-3 border-t-3 border-gray-300 bg-yellow-50">
          <div class="relative flex items-center gap-2">
            <input 
              id="chat-input" 
              type="text" 
              placeholder="è¾“å…¥æ‚¨çš„æƒ³æ³•ï¼ŒæŒ‰Enterå‘é€..." 
              class="flex-1 p-2 border-2 border-gray-800 focus:border-cyan-500 focus:outline-none transition-colors font-medium"
            />
            <button id="send-button" class="text-cyan-600 hover:text-cyan-700 transition-colors p-2 hover:scale-110 transform duration-200">
              <iconify-icon icon="ph:paper-plane-tilt-fill" class="text-3xl"></iconify-icon>
            </button>
          </div>
        </div>
      </div>
    
      <!-- å³ä¾§æ˜¾ç¤ºé¢æ¿ -->
      <div class="md:col-span-2 bg-white wild-border border-purple-600 flex flex-col">
        <div id="svg-viewer" class="flex-1 flex items-center justify-center p-4 bg-gradient-to-br from-purple-50 to-pink-50 overflow-auto">
          <div id="svg-placeholder" class="text-center text-gray-400">
            <iconify-icon icon="ph:image-square" class="text-6xl mx-auto text-purple-400"></iconify-icon>
            <p class="mt-2 font-bold" id="placeholder-text">ç”Ÿæˆçš„äº§å“ç”»å¸ƒå°†åœ¨æ­¤å¤„æ˜¾ç¤º</p>
          </div>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="p-3 border-t-3 border-gray-300 flex justify-end items-center gap-2 bg-gray-800">
          <button id="download-svg-btn" class="p-2 bg-orange-500 text-white border-2 border-black hover:bg-orange-600 transition-all" title="ä¸‹è½½SVG">
            <iconify-icon icon="mdi:download-outline" class="text-xl"></iconify-icon>
          </button>
          <button id="export-image-btn" class="p-2 bg-green-500 text-white border-2 border-black hover:bg-green-600 transition-all" title="å¯¼å‡ºä¸ºå›¾ç‰‡">
            <iconify-icon icon="mdi:image-outline" class="text-xl"></iconify-icon>
          </button>
          <button id="view-code-btn" class="p-2 bg-blue-500 text-white border-2 border-black hover:bg-blue-600 transition-all" title="æŸ¥çœ‹ä»£ç ">
            <iconify-icon icon="mdi:code-tags" class="text-xl"></iconify-icon>
          </button>
        </div>
      </div>
    
    </main>

    <!-- APIé…ç½®æ¨¡æ€çª— -->
    <div id="config-modal" class="modal-overlay">
      <div class="modal-content">
        <!-- æ¨¡æ€çª—å¤´éƒ¨ -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 border-b-4 border-black flex items-center justify-between">
          <div class="flex items-center gap-2">
            <iconify-icon icon="ph:plugs-connected-fill" class="text-3xl text-white"></iconify-icon>
            <h2 class="text-xl font-black text-white">API é…ç½®</h2>
          </div>
          <button id="close-modal-btn" class="text-white hover:bg-white/20 p-2 transition-all">
            <iconify-icon icon="ph:x-bold" class="text-2xl"></iconify-icon>
          </button>
        </div>
        
        <!-- æ¨¡æ€çª—å†…å®¹ -->
        <div class="p-6 space-y-4">
          <!-- API URL -->
          <div>
            <label class="block font-bold text-gray-800 mb-2 flex items-center gap-2">
              <iconify-icon icon="ph:link-bold" class="text-lg text-blue-600"></iconify-icon>
              API URL
            </label>
            <input 
              id="api-url" 
              type="text" 
              placeholder="https://api.example.com/v1/chat" 
              class="config-input"
              value=""
            />
          </div>
          
          <!-- API Key -->
          <div>
            <label class="block font-bold text-gray-800 mb-2 flex items-center gap-2">
              <iconify-icon icon="ph:key-bold" class="text-lg text-green-600"></iconify-icon>
              API Key
            </label>
            <input 
              id="api-key" 
              type="password" 
              placeholder="sk-xxxxxxxxxxxxxxxx" 
              class="config-input"
              value=""
            />
          </div>
          
          <!-- Model -->
          <div>
            <label class="block font-bold text-gray-800 mb-2 flex items-center gap-2">
              <iconify-icon icon="ph:robot-bold" class="text-lg text-purple-600"></iconify-icon>
              æ¨¡å‹ (Model)
            </label>
            <input 
              id="api-model" 
              type="text" 
              placeholder="gpt-4-turbo" 
              class="config-input"
              value=""
            />
          </div>
          
          <!-- çŠ¶æ€æ˜¾ç¤º -->
          <div id="config-status" class="p-3 border-2 border-gray-300 bg-gray-50 text-sm text-gray-600 hidden">
            <iconify-icon icon="ph:info" class="align-middle"></iconify-icon>
            <span id="status-text">ç­‰å¾…æ“ä½œ...</span>
          </div>
        </div>
        
        <!-- æ¨¡æ€çª—åº•éƒ¨æŒ‰é’® -->
        <div class="p-4 border-t-3 border-gray-300 bg-gray-100 flex gap-3 justify-end">
          <button id="test-api-btn" class="px-4 py-2 bg-yellow-500 text-white font-bold border-2 border-black hover:bg-yellow-600 transition-all flex items-center gap-2">
            <iconify-icon icon="ph:flask-bold"></iconify-icon>
            æµ‹è¯•è¿æ¥
          </button>
          <button id="save-config-btn" class="px-4 py-2 bg-green-500 text-white font-bold border-2 border-black hover:bg-green-600 transition-all flex items-center gap-2">
            <iconify-icon icon="ph:floppy-disk-bold"></iconify-icon>
            ä¿å­˜é…ç½®
          </button>
        </div>
      </div>
    </div>

    <script>
      // ===== å…¨å±€å˜é‡ =====
      let currentMode = 'canvas';
      let svgStorage = {};
      let currentSvgId = null;
      let apiConfig = {
        url: '',
        key: '',
        model: ''
      };
      
      // ===== DOMå…ƒç´  =====
      const canvasBtn = document.getElementById('canvas-mode-btn');
      const swotBtn = document.getElementById('swot-mode-btn');
      const pageTitle = document.getElementById('page-title');
      const placeholderText = document.getElementById('placeholder-text');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');
      const chatHistory = document.getElementById('chat-history');
      const svgViewer = document.getElementById('svg-viewer');
      
      // æ¨¡æ€çª—å…ƒç´ 
      const settingsBtn = document.getElementById('settings-btn');
      const configModal = document.getElementById('config-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const apiUrlInput = document.getElementById('api-url');
      const apiKeyInput = document.getElementById('api-key');
      const apiModelInput = document.getElementById('api-model');
      const testApiBtn = document.getElementById('test-api-btn');
      const saveConfigBtn = document.getElementById('save-config-btn');
      const configStatus = document.getElementById('config-status');
      const statusText = document.getElementById('status-text');
      
      // ===== åˆå§‹åŒ– - åŠ è½½å·²ä¿å­˜çš„é…ç½® =====
      function loadConfig() {
        const saved = localStorage.getItem('apiConfig');
        if (saved) {
          apiConfig = JSON.parse(saved);
          apiUrlInput.value = apiConfig.url || '';
          apiKeyInput.value = apiConfig.key || '';
          apiModelInput.value = apiConfig.model || '';
        }
      }
      
      // ===== æ¨¡æ€çª—æ§åˆ¶ =====
      settingsBtn.addEventListener('click', () => {
        configModal.classList.add('active');
        loadConfig();
      });
      
      closeModalBtn.addEventListener('click', () => {
        configModal.classList.remove('active');
      });
      
      configModal.addEventListener('click', (e) => {
        if (e.target === configModal) {
          configModal.classList.remove('active');
        }
      });
      
      // ===== ä¿å­˜é…ç½® =====
      saveConfigBtn.addEventListener('click', () => {
        apiConfig.url = apiUrlInput.value.trim();
        apiConfig.key = apiKeyInput.value.trim();
        apiConfig.model = apiModelInput.value.trim();
        
        if (!apiConfig.url || !apiConfig.key || !apiConfig.model) {
          showStatus('âš ï¸ è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
          return;
        }
        
        localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
        showStatus('âœ… é…ç½®å·²ä¿å­˜æˆåŠŸï¼', 'success');
        
        setTimeout(() => {
          configModal.classList.remove('active');
        }, 1500);
      });
      
      // ===== æµ‹è¯•APIè¿æ¥ =====
      testApiBtn.addEventListener('click', async () => {
        const url = apiUrlInput.value.trim();
        const key = apiKeyInput.value.trim();
        const model = apiModelInput.value.trim();
        
        if (!url || !key || !model) {
          showStatus('âš ï¸ è¯·å…ˆå¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
          return;
        }
        
        showStatus('ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...', 'loading');
        
        // TODO: å®ç°çœŸå®çš„APIæµ‹è¯•
        setTimeout(() => {
          // æ¨¡æ‹Ÿæµ‹è¯•æˆåŠŸ
          showStatus('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
          
          // çœŸå®å®ç°ç¤ºä¾‹ï¼š
          /*
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${key}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: model,
                messages: [{role: 'user', content: 'test'}],
                max_tokens: 5
              })
            });
            
            if (response.ok) {
              showStatus('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
              showStatus('âŒ è¿æ¥å¤±è´¥: ' + response.statusText, 'error');
            }
          } catch (error) {
            showStatus('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
          }
          */
        }, 1500);
      });
      
      // ===== æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯ =====
      function showStatus(message, type) {
        configStatus.classList.remove('hidden');
        statusText.textContent = message;
        
        configStatus.classList.remove('border-gray-300', 'bg-gray-50', 'text-gray-600');
        configStatus.classList.remove('border-green-500', 'bg-green-50', 'text-green-700');
        configStatus.classList.remove('border-red-500', 'bg-red-50', 'text-red-700');
        configStatus.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
        
        if (type === 'success') {
          configStatus.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
        } else if (type === 'error') {
          configStatus.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
        } else if (type === 'loading') {
          configStatus.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
        } else {
          configStatus.classList.add('border-gray-300', 'bg-gray-50', 'text-gray-600');
        }
      }
      
      // ===== æ¨¡å¼åˆ‡æ¢ =====
      canvasBtn.addEventListener('click', () => {
        if (currentMode !== 'canvas') {
          currentMode = 'canvas';
          updateModeUI();
        }
      });
      
      swotBtn.addEventListener('click', () => {
        if (currentMode !== 'swot') {
          currentMode = 'swot';
          updateModeUI();
        }
      });
      
      function updateModeUI() {
        if (currentMode === 'canvas') {
          canvasBtn.classList.add('mode-btn-active');
          canvasBtn.classList.remove('mode-btn-inactive');
          swotBtn.classList.remove('mode-btn-active');
          swotBtn.classList.add('mode-btn-inactive');
          pageTitle.textContent = 'äº§å“ç”»å¸ƒ';
          if (!currentSvgId) {
            placeholderText.textContent = 'ç”Ÿæˆçš„äº§å“ç”»å¸ƒå°†åœ¨æ­¤å¤„æ˜¾ç¤º';
          }
        } else {
          swotBtn.classList.add('mode-btn-active');
          swotBtn.classList.remove('mode-btn-inactive');
          canvasBtn.classList.remove('mode-btn-active');
          canvasBtn.classList.add('mode-btn-inactive');
          pageTitle.textContent = 'SWOTåˆ†æ';
          if (!currentSvgId) {
            placeholderText.textContent = 'ç”Ÿæˆçš„SWOTåˆ†æå°†åœ¨æ­¤å¤„æ˜¾ç¤º';
          }
        }
      }
      
      // ===== å‘é€æ¶ˆæ¯ =====
      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // æ£€æŸ¥APIé…ç½®
        if (!apiConfig.url || !apiConfig.key || !apiConfig.model) {
          alert('âš ï¸ è¯·å…ˆé…ç½®APIè®¾ç½®ï¼ç‚¹å‡»å³ä¸Šè§’é½¿è½®å›¾æ ‡è¿›è¡Œé…ç½®ã€‚');
          settingsBtn.click();
          return;
        }
        
        addUserMessage(message);
        chatInput.value = '';
        
        // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼ˆTODO: æ›¿æ¢ä¸ºçœŸå®è°ƒç”¨ï¼‰
        setTimeout(() => {
          simulateAPIResponse(message);
        }, 1000);
      }
      
      // ===== æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ =====
      function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-end';
        messageDiv.innerHTML = `
          <div class="chat-bubble-user">
            ${escapeHtml(text)}
          </div>
        `;
        chatHistory.appendChild(messageDiv);
        scrollToBottom();
      }
      
      // ===== æ·»åŠ AIæ¶ˆæ¯ =====
      function addAIMessage(fullResponse) {
        const messageId = 'msg-' + Date.now();
        const parsed = parseSVGResponse(fullResponse);
        
        if (parsed.svgContent) {
          const svgId = 'svg-' + Date.now();
          svgStorage[svgId] = {
            content: parsed.svgContent,
            messageId: messageId
          };
          
          viewSVG(svgId);
          
          const messageDiv = document.createElement('div');
          messageDiv.className = 'flex justify-start';
          messageDiv.innerHTML = `
            <div class="chat-bubble-ai relative group" data-message-id="${messageId}">
              <div>
                ${escapeHtml(parsed.beforeText)}
                <div class="svg-placeholder-block" data-svg-id="${svgId}" onclick="viewSVG('${svgId}')">
                  ğŸ“Š ç‚¹å‡»æŸ¥çœ‹ SVG
                </div>
                ${escapeHtml(parsed.afterText)}
              </div>
              
              <div class="flex gap-2 mt-2 pt-2 border-t border-gray-200">
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-blue-600 transition-colors" onclick="rollbackToMessage('${messageId}')">
                  <iconify-icon icon="ph:arrow-u-up-left-bold"></iconify-icon>
                  <span>é€€å›</span>
                </button>
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-green-600 transition-colors" onclick="regenerateMessage('${messageId}')">
                  <iconify-icon icon="ph:arrow-clockwise-bold"></iconify-icon>
                  <span>é‡æ–°ç”Ÿæˆ</span>
                </button>
              </div>
            </div>
          `;
          chatHistory.appendChild(messageDiv);
        } else {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'flex justify-start';
          messageDiv.innerHTML = `
            <div class="chat-bubble-ai relative group" data-message-id="${messageId}">
              <div class="mb-1">
                ${escapeHtml(fullResponse)}
              </div>
              
              <div class="flex gap-2 mt-2 pt-2 border-t border-gray-200">
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-blue-600 transition-colors" onclick="rollbackToMessage('${messageId}')">
                  <icon ify-icon icon="ph:arrow-u-up-left-bold"></iconify-icon>
                  <span>é€€å›</span>
                </button>
                <button class="bubble-action-btn flex items-center gap-1 text-xs text-gray-600 hover:text-green-600 transition-colors" onclick="regenerateMessage('${messageId}')">
                  <iconify-icon icon="ph:arrow-clockwise-bold"></iconify-icon>
                  <span>é‡æ–°ç”Ÿæˆ</span>
                </button>
              </div>
            </div>
          `;
          chatHistory.appendChild(messageDiv);
        }
        
        scrollToBottom();
      }
      
      // ===== è§£æSVGå“åº” =====
      function parseSVGResponse(response) {
        const svgRegex = /```svg\s*([\s\S]*?)```/i;
        const match = response.match(svgRegex);
        
        if (match) {
          const svgContent = match[1].trim();
          const beforeText = response.substring(0, match.index).trim();
          const afterText = response.substring(match.index + match[0].length).trim();
          
          return {
            svgContent,
            beforeText,
            afterText
          };
        }
        
        return {
          svgContent: null,
          beforeText: response,
          afterText: ''
        };
      }
      
      // ===== æ˜¾ç¤ºSVG =====
      function viewSVG(svgId) {
        if (!svgStorage[svgId]) {
          console.error('SVG not found:', svgId);
          return;
        }
        
        currentSvgId = svgId;
        const svgContent = svgStorage[svgId].content;
        svgViewer.innerHTML = svgContent;
      }
      
      // ===== æ°”æ³¡æ“ä½œåŠŸèƒ½ =====
      function rollbackToMessage(messageId) {
        console.log('é€€å›åˆ°æ¶ˆæ¯:', messageId);
        // TODO: å®ç°é€€å›é€»è¾‘
      }
      
      function regenerateMessage(messageId) {
        console.log('é‡æ–°ç”Ÿæˆæ¶ˆæ¯:', messageId);
        // TODO: å®ç°é‡æ–°ç”Ÿæˆé€»è¾‘
      }
      
      // ===== åº•éƒ¨æ“ä½œæŒ‰é’® =====
      document.getElementById('download-svg-btn').addEventListener('click', () => {
        if (!currentSvgId) {
          alert('è¯·å…ˆç”ŸæˆSVGå›¾è¡¨');
          return;
        }
        
        const svgContent = svgStorage[currentSvgId].content;
        const blob = new Blob([svgContent], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentMode}-${Date.now()}.svg`;
        a.click();
        URL.revokeObjectURL(url);
      });
      
      document.getElementById('export-image-btn').addEventListener('click', () => {
        if (!currentSvgId) {
          alert('è¯·å…ˆç”ŸæˆSVGå›¾è¡¨');
          return;
        }
        console.log('å¯¼å‡ºä¸ºå›¾ç‰‡:', currentSvgId);
        // TODO: å®ç°SVGè½¬PNGåŠŸèƒ½
      });
      
      document.getElementById('view-code-btn').addEventListener('click', () => {
        if (!currentSvgId) {
          alert('è¯·å…ˆç”ŸæˆSVGå›¾è¡¨');
          return;
        }
        
        const svgContent = svgStorage[currentSvgId].content;
        alert('SVGä»£ç ï¼š\n\n' + svgContent);
        // TODO: ä½¿ç”¨æ›´å¥½çš„ä»£ç å±•ç¤ºå¼¹çª—
      });
      
      // ===== å·¥å…·å‡½æ•° =====
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      function scrollToBottom() {
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
      
      // ===== æ¨¡æ‹ŸAPIå“åº”ï¼ˆæµ‹è¯•ç”¨ï¼‰ =====
      function simulateAPIResponse(userMessage) {
        const mockResponses = [
          `å¥½çš„ï¼æˆ‘ä¸ºæ‚¨ç”Ÿæˆäº†ä¸€ä¸ª${currentMode === 'canvas' ? 'äº§å“ç”»å¸ƒ' : 'SWOTåˆ†æ'}
\`\`\`svg
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
  <rect width="100%" height="100%" fill="#f0f0f0"/>
  <text x="300" y="200" text-anchor="middle" font-size="24" fill="#333">
    è¿™æ˜¯${currentMode === 'canvas' ? 'äº§å“ç”»å¸ƒ' : 'SWOTåˆ†æ'}ç¤ºä¾‹SVG
  </text>
  <circle cx="300" cy="250" r="50" fill="#667eea" opacity="0.5"/>
</svg>
\`\`\`
åŒ…å«äº†å…³é”®è¦ç´ å’Œæ¨¡å—ã€‚ç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾å¯åœ¨å³ä¾§æŸ¥çœ‹è¯¦ç»†å›¾è¡¨ã€‚`,

          `å·²ç»ä¸ºæ‚¨è°ƒæ•´å®Œæˆï¼
\`\`\`svg
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#grad1)"/>
  <text x="300" y="200" text-anchor="middle" font-size="28" fill="white" font-weight="bold">
    ${currentMode === 'canvas' ? 'ä¼˜åŒ–åçš„äº§å“ç”»å¸ƒ' : 'ä¼˜åŒ–åçš„SWOTåˆ†æ'}
  </text>
</svg>
\`\`\`
é‡‡ç”¨äº†æ›´åŠ é²œæ˜çš„è‰²å½©ç»„åˆï¼Œå¸Œæœ›æ‚¨æ»¡æ„ï¼`
        ];
        
        const response = mockResponses[Math.floor(Math.random() * mockResponses.length)];
        addAIMessage(response);
      }
      
      // ===== é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– =====
      loadConfig();
    </script>

</body>
</html>
```